---
title: "Consumer-Staples-Sector"
author: "Mandar"
date: "2022-08-21"
output: 
   html_document:
     code_folding: show
     df_print: paged
     highlight: tango
     number_sections: yes
     theme: flatly
     toc: yes
     toc_depth: 2
    
  
---

```{r }
knitr::opts_chunk$set(echo = TRUE,fig.align = "center",
                        message = FALSE,
                      warning = FALSE)
options(tinytex.verbose = TRUE)
```
```{r}
rm(list = ls())
graphics.off()
```

# loading the required libraries


```{r }
library(tidymodels)
library(tidyquant)
library(tidyverse)
library(scales)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(plotly)
library(timetk)
library(modeltime)
library(DataExplorer)
library(correlationfunnel)
```
# Consumer Staples :
The term consumer staples refers to a set of essential products used by consumers. This category includes things like foods and beverages, household goods, and hygiene products as well as alcohol and tobacco. These goods are those products that people are unable—or unwilling—to cut out of their budgets regardless of their financial situation


```{r }
symbols <- c("PG","KO","COST","WMT","KR") %>% sort()

prices <-  symbols %>%
    tq_get(get = "stock.prices", from = "1990-01-01")

returns <-  prices %>%
    group_by(symbol)%>%
    select(symbol, date, adjusted) %>%
    tq_transmute(select     = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
                 ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))
```
# Visualization of Stock Prices With plot_time_series
```{r}
# We use plot_time_series 
prices %>%
    group_by(symbol) %>%
    plot_time_series(
        .date_var = date,
        .value = adjusted,
        .color_var = symbol,
        .facet_ncol = 2,
        .interactive = FALSE,
        .smooth = FALSE
        ) + scale_y_continuous(labels = scales::dollar) + scale_color_tq(theme = "light") +
theme_tq() +
  labs(
    title = "Consumer Staples Stock Prices",
    subtitle = "Rising trend",
    x = "",
    y ="Adjusted Prices"
  ) + theme(legend.position = "none")
  
```
# Visualization of Returns 
```{r}
returns %>%
    group_by(symbol) %>%
    plot_time_series(
        .date_var   = date, 
        .value      = monthly.returns,
        .color_var  = symbol,
        .facet_ncol = 2,
        .interactive = FALSE,
        .smooth_degree = 0,
        .smooth_alpha = 0.5,
        .smooth_size = 0.5,
        .smooth_color = "black",
        
    ) + theme_tq() +
  scale_y_continuous(labels = scales::percent) + scale_color_tq(theme = "light") +
  labs(title = "Monthly Returns : Consumer Staples Stocks",
       subtitle = "Period of Volatility observed around 2000/2010",
       x ="",
       y ="Monthly Returns") + theme(legend.position = "none")
  
```
# ggplot visualization for the same
```{r}
returns %>%
    group_by(symbol) %>%
    ggplot(aes(date, monthly.returns, color = symbol)) +
    geom_line() + facet_wrap(~ symbol) +
    scale_y_continuous(labels = scales::percent) +
    theme_tq() + scale_color_tq(theme = "dark") +
    theme(legend.position = "none") + geom_smooth(method = "loess", color = "Black")+
    labs(
        title = "Monthly Returns of Consumer staple Stocks",
        subtitle = "High volatility observed for 2000-02",
        x="",
        y= ""
    )
```
# Portfolio Construction with Equal Weights

```{r}
w <- c(0.2,0.2,0.2,0.2,0.2)
port_returns_tbl <- returns %>%
  group_by(symbol) %>%
  tq_portfolio(
    assets_col  = symbol,
    returns_col = monthly.returns,
    weights     = w,
    col_rename = "monthly.returns",
    rebalanc_on = "years"
   ) %>%
  add_column(symbol = "Portfolio", .before = 1)

port_returns_tbl

# Visualize the Portfolio

port_returns_tbl %>%
  plot_time_series(
    .date_var = date,
    .value = monthly.returns * 100,
    .color_var = symbol,
    .title = "Portfolio Returns ",
    .x_lab = "",
    .y_lab = "Monthyl Returns (%)"
  )
  
  

```
# ggplot for Portfolio returns
```{r}
port_returns_tbl %>%
  ggplot(aes(date,monthly.returns, color = symbol)) +
  geom_line() +
  geom_smooth(method = "loess", color = "Blue") +
  scale_y_continuous(labels = scales::percent)  + 
  theme_tq() + scale_color_tq(theme = "light") +
  labs(
    title = "Portfolio Returns",
    subtitle = "High Volatility Periods of 2000, 2008,2021",
    x = "",
    y = "Monthly Returns"
  ) + 
  theme(legend.position = "none")
```
# S&P 500 and visualization
```{r}
market_index <- tq_get("^GSPC",get = "stock.prices",from = "1990-01-01")

market_returns <- market_index %>%
  select(symbol, date, adjusted) %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               ) %>%
  mutate(date = rollback(date, roll_to_first = TRUE)) %>%
  add_column(symbol = "GSPC", .before = 1) 

```
# S&P500 visualiaztion
```{r}
market_returns %>%
  ggplot(aes(date, monthly.returns, color = symbol)) +
  geom_line() + geom_smooth(method = "loess", color = "Blue") +
  scale_y_continuous(labels = scales::percent) +
  scale_color_tq(theme = "light") +
  labs(
    title = "S&P 500 Monthly Returns",
    subtitle = "High Volatility observed 2000,2008,2021",
    x = ""
  )  +
  theme(legend.position = "none")
  
```
# Combining the data : 
##Step 1 Portfolio returns and Stock Returns
                      
```{r}
combined_tbl <- port_returns_tbl %>%
  rbind(returns %>% group_by(symbol)) 
```
### Visualization of the combined returns
```{r}
combined_tbl %>%
  group_by(symbol) %>%
  plot_time_series(
    .date_var = date, 
    .value = monthly.returns * 100,
    .color_var = symbol,
    .smooth = FALSE,
    .facet_ncol = 2,
    .facet_scales = "free",
    .title = "Time Series Plot Individual Stocks vs Portfolio",
    .x_lab = "",
    .y_lab = "monthly returns(%)"
  )

```
## Step 2: Combining all the data
```{r}
port_stocks_market_tbl <- combined_tbl  %>%
  group_by(symbol) %>%
  rbind(market_returns)
```

### Visualization 
```{r}
port_stocks_market_tbl %>%
  plot_time_series(
    .date_var   = date,
    .value      = monthly.returns * 100,
    .color_var  = symbol,
    .facet_ncol =  3,
    .facet_scales = "free",
    .title = "Time Series Plot Individual Stocks vs Portfolio Vs Market Index",
    .x_lab = "",
    .y_lab = "Monthly Returns(%)",
    .legend_show = F
  )

```
### ggplot visualization
```{r}
port_stocks_market_tbl %>%
  ggplot(aes(date,monthly.returns, color = symbol)) +
  geom_line() + 
  scale_y_continuous(labels = scales::percent) + 
  theme_tq() + scale_color_tq() + facet_wrap(~symbol, ncol = 3) +
  theme(legend.position = "none")
```

# Regression Analysis : 
## Portfolio and Market Index
```{r}
# we need to combine the portfolio returns with market_returns

market_returns_tbl <- market_returns %>%
  select(-symbol) %>%
  rename(market.returns = monthly.returns)

market_returns_tbl

# Combining portfolio and market
port_market_tbl <- port_returns_tbl %>%
  left_join(market_returns_tbl, by = "date") 

# Second step to visualize the regression
port_market_tbl %>%
  plot_time_series_regression(
    .date_var = date,
    .formula = monthly.returns ~ market.returns,
    .show_summary = TRUE,
    .title = "Impact of "
  )
```
# Regression Analysis: Individual Stocks &  Market Index
```{r}
returns_market_tbl <- returns %>%
  group_by(symbol) %>%
  left_join(market_returns_tbl, by = "date")
  
returns_market_tbl%>%
  plot_time_series_regression(
    .date_var = date,
    .formula = monthly.returns ~ market.returns,
    .show_summary = TRUE,
    .facet_ncol = 2,
    .title = "Impact of Market on Individual Stocks",
    .x_lab = "",
    .y_lab = "Estimates"
  )



```
# # Beta estimation
```{r}
lm(monthly.returns ~ market.returns, data = port_market_tbl) %>%
  tidy() %>%
  select(term, estimate,statistic) %>%
  mutate_at(vars(-'term'), round, 2) %>% 
  mutate(term = ifelse(term == "(Intercept)", "Intercept", "Market risk premium")) %>% 
  rename("Term" = term,
         "Size effect" = estimate,
         "Statistic" = statistic) %>% 
  knitr::kable(caption = "Regression output:
               Portfolio vs. S&P 500 returns")
  

```
# Fama-French 3 factors
```{r}
library(frenchdata)
# To have a look at available data 
#get_french_data_list()
# We are downloading the Fama-French 3 factors with  monthly frequency
# the first line of the code downloads the data in a list
factors_ff_monthly_raw <- download_french_data("Fama/French 3 Factors")
# this part of the code select which data we need and change the variables in correct format
factors_ff_monthly <- factors_ff_monthly_raw$subsets$data[[1]] |>
  transmute(
    date = floor_date(ymd(str_c(date,"01")),"month"),
    rf = as.numeric(RF) / 100,
    mkt_excess = as.numeric(`Mkt-RF`) / 100,
    smb = as.numeric(SMB) / 100,
    hml = as.numeric(HML) / 100
  ) %>%
  # filter the dates 
  filter(date >= "1990-01-01")

factors_ff_monthly 
```
# Combining our  Portfolio ,these factors 


```{r}
port_risk_tbl <- port_returns_tbl  %>%
  left_join(factors_ff_monthly, by = "date")


```
# Correlation funnel
```{r}
library(correlationfunnel)
port_risk_tbl %>%
  mutate(monthly.returns = monthly.returns - rf) %>%
  select(-rf,-symbol,-date)%>%
  drop_na() %>%
  correlate(monthly.returns) %>%
  filter(!feature =="monthly.returns") %>%
  mutate(correlation = round(correlation,2)) %>%
  plot_correlation_funnel(,interactive = FALSE) +
  geom_label(aes(label = correlation %>% scales::percent()), hjust = "outward", size = 8)+
geom_segment(aes(x = correlation, y = feature, xend = 0, yend = feature)) +
  labs(
    title = "Correlation chart for Consumer Staples Portfolio and Fama-French 3 Factors",
    subtitle = "Very High correlation with market risk premium(mkt_excess), and negative correltion to the size effect based on market capitalization of the company(smb)",
    y = "Fama-French Factors"
  )


```
# Combining with Market Index
```{r} 
# Modifying the market returns
market_index_tbl <- market_index %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               col_rename = "market_returns") %>%
  mutate(date = rollback(date, roll_to_first = TRUE))

port_risk_tbl %>%
  left_join(market_index_tbl, by = "date") %>%
  mutate(market_returns = market_returns -rf,
         monthly.returns = monthly.returns -rf) %>%
  select(-symbol, -date, -rf) %>%
  drop_na() %>%
  correlate(monthly.returns) %>%
  filter(!feature=="monthly.returns") %>%
  plot_correlation_funnel(,interactive = FALSE, limits = c(-1,1)) +
 geom_label(aes(label = correlation %>% scales::percent()), hjust = "outward", size = 8)+
    geom_segment(aes(x = correlation, y = feature, xend = 0, yend = feature)) +
  labs(
    title = "Correlation chart Consumer Staples Portfolio",
    subtitle = "Very strong postive correlation with the market_returns and market premium(mkt_excess) "
    
    )

```
# Regression analysis : 
```{r}



port_market_tbl %>% left_join(factors_ff_monthly, by = "date") %>%
  drop_na() %>%
  mutate(excess_returns = monthly.returns -rf,
         market_returns = market.returns -rf) %>%
  select(-monthly.returns, -market.returns, -symbol,-rf) %>%
  plot_time_series_regression(
    .date_var = date,
    .formula = excess_returns ~ . -date,
    .show_summary = TRUE
    
  )


  
```
# Beta Estimation for Individual Stocks
## Step 1 : Function for rolling capm estimation
```{r}

library(slider)
# Using the function defined in the Book Tidy Finance With R
estimate_capm <- function(data, min_obs = 1) {
  if (nrow(data) < min_obs) {
    beta <- as.numeric(NA)
  } else {
    fit <- lm(excess_returns ~ mkt_excess + smb+hml+ market_returns, data = data)
    beta <- as.numeric(fit$coefficients[2])
  }
  return(beta)
}
roll_capm_estimation <- function(data, months, min_obs) {
  data <- bind_rows(data) |>
    arrange(date)

  betas <- slide_period_vec(
    .x = data,
    .i = data$date,
    .period = "month",
    .f = ~estimate_capm(., min_obs),
    .before = months - 1,
    .complete = FALSE
  )

  tibble(
    month = unique(data$date),
    beta = betas
  )
}


```
## Step 2: Combining  returns ,risk factors and s&p 500 
```{r}
returns_market_risk_tbl <- returns_market_tbl %>%
  left_join(factors_ff_monthly,by = "date") %>%
  mutate(excess_returns = monthly.returns -rf) %>%
  mutate(market_returns = market.returns -rf) %>%
  select(symbol, date, excess_returns, market_returns, mkt_excess:hml)

```
##Step3: Lets plot the regression 

```{r}
returns_market_risk_tbl %>%
  plot_time_series_regression(
    .date_var = date,
    .formula = excess_returns~. -date,
    .facet_ncol = 2,
    .show_summary = TRUE
  
  )
  

```
##Step 4: 
```{r}
beta_tbl <- returns_market_risk_tbl %>%
  drop_na() %>%
  select(symbol, date, excess_returns:hml) %>%
  mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) |>
  ungroup() %>%
  drop_na() %>%
  select(symbol, date, beta_monthly = beta)
  

```
##Step5 : Beta Visualiaztion
```{r}
B <- beta_tbl %>%
  group_by(symbol) %>%
  ggplot(aes(date, beta_monthly, color = symbol)) +
  geom_line() + scale_y_continuous() + scale_color_tq() + theme_tq() +
  labs(
    title = "Rolling Beta Estimation using 5 Years of data",
    subtitle = "Selected Consumer Staples Stocks",
    x ="",
    y ="Beta"
    ) + theme(legend.position = "none")
ggplotly(B)
```
# Step 6 : Beta for Portfolio
```{r}
port_risk_market_tbl <- port_risk_tbl %>%
  left_join(market_index_tbl, by = "date") %>%
  mutate(market_returns = market_returns -rf,
         excess_returns = monthly.returns -rf) %>%
  select(-rf)

beta_port_tbl <- port_risk_market_tbl %>% 
  select(symbol, date, excess_returns, market_returns, mkt_excess, smb, hml) %>%
  mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
  drop_na() %>%
  select(symbol, date, beta_monthly = beta) 
  
beta_port_tbl%>%
  plot_time_series(
    .date_var = date,
    .value = beta_monthly,
    .title = "Rolling Beta for Consumer Staples Portfolio ",
    .x_lab = "",
    .y_lab = "Beta",
    .smooth = FALSE
  )
   

```
```{r}
P <- beta_port_tbl %>%
  ggplot(aes(date, beta_monthly, color = symbol)) +
  geom_line( size = 1) + theme_tq() + scale_y_continuous() + scale_color_tq(theme="dark") +
  labs(
    title = "Rolling Beta with 5 years data",
    subtitle = "Consumer Staples Portfolio",
    x = "",
    
  ) + theme(legend.position = "none")

ggplotly(P)
```




























