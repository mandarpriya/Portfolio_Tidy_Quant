---
title: "Utilities_Sector"
author: "Mandar"
date: "2022-08-25"
output: 
     html_document :
      code_folding: hide
      df_print: paged
      highlight: tango
      number_sections: yes
      theme: flatly
      toc: yes
      toc_depth: 2
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,fig.align = "center",
                        message = FALSE,
                      warning = FALSE)
options(tinytex.verbose = TRUE)
```

Utilities include large companies that offer multiple services such as electricity and natural gas or specialize in just one type of service, such as water. Some utilities rely on clean and renewable energy sources like wind turbines and solar panels to produce electricity.Utilities typically offer investors stable and consistent dividends, coupled with less price volatility relative to the overall equity markets. As a result, utilities tend to perform well during recessions and economic downturns. Conversely, utility stocks tend to fall out of favor with the market during times of economic growth.

# loading the required libraries
```{r }
library(tidymodels)
library(tidyquant)
library(tidyverse)
library(scales)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(plotly)
library(timetk)
library(modeltime)
library(DataExplorer)
library(correlationfunnel)
```
# Downloading the data for the Utilities Sector:


```{r }
symbols <- c("DUK","UGI","D","AEP","NEE") %>% sort() 

prices <-  symbols %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns <-  prices %>%
    group_by(symbol) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

```

# Returns Visualization

```{r}
returns %>%
    group_by(symbol) %>%
    ggplot(aes(date, monthly.returns, color = symbol))+
    geom_line() + scale_y_continuous(labels = scales::percent) +
    facet_wrap(~symbol) + geom_smooth(method = "loess", color = "Black") +
    theme_tq() + scale_color_tq(theme = "light") + 
    labs(
        title = "Monthly Returns ",
        subtitle = "High Volatility Observed around 2000, 2008, 2020",
        y = "Monthly Returns",
        x = ""
    ) + theme(legend.position = "none")
```
# Portfolio Construction
```{r}
# weight allocation
w <- rep(1/5, 5)
port_ret_tbl <- returns %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col  = symbol, 
        returns_col = monthly.returns,
        weights     =   w
    ) %>%
    add_column(symbol = "Portfolio", .before = 1)
    
```
# Portfolio Returns Visualization
```{r}
port_ret_tbl %>%
    plot_time_series(.date_var = date,
                     .value = portfolio.returns,
                     .title = "Portfolio Returns for Utilities Sector",
                     .y_lab = "Monthly Returns",
                     .x_lab = "")
```
# ggplot
```{r}

port_ret_tbl %>%
    ggplot(aes(date, portfolio.returns)) +
    geom_line(color = "red") + geom_smooth(method = "loess") +
    scale_y_continuous(labels = scales::percent) + scale_color_tq() + theme_tq() +
    labs(
        title = "Portfolio Returns",
        subtitle = "Utilities Sector",
        caption = "Stocks(DUK,D,AEP,UGI;NEE)",
        x ="",
        y ="Monthly Returns"
    )
```
# S&P 500 
```{r}

market_prices <- tq_get("^GSPC", from = "1990-01-01")
market_returns <- market_prices %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
                 col_rename = "market_ret"
                 ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

```
# Fama-French Factors
```{r}
library(frenchdata)
factors_ff_monthly_raw <- download_french_data("Fama/French 3 Factors")
factors_ff_monthly <- factors_ff_monthly_raw$subsets$data[[1]] |>
  transmute(
    date = floor_date(ymd(str_c(date,"01")),"month"),
    rf = as.numeric(RF) / 100,
    mkt_excess = as.numeric(`Mkt-RF`) / 100,
    smb = as.numeric(SMB) / 100,
    hml = as.numeric(HML) / 100
  ) %>%
  # filter the dates 
  filter(date >= "1990-01-01")

factors_ff_monthly 
```
# Combining all the data
```{r}

port_risk_market_tbl <- port_ret_tbl %>%
    left_join(market_returns, by = "date") %>%
    left_join(factors_ff_monthly, by = "date") %>%
    mutate(excess_returns =  portfolio.returns -rf) %>%
    mutate(market_excess_returns = market_ret -rf) %>%
    drop_na()  %>%
    select(date, mkt_excess:market_excess_returns)
```
# Visualization of combined data
```{r}

port_risk_market_tbl %>%
    plot_time_series_regression(
        .date_var = date,
        .formula = excess_returns ~. -date,
        .show_summary = TRUE,
        
    )
    
```
# Beta Estimation
## Step 1 : CAPM Function
```{r}
library(slider)
# estimate capm
estimate_capm <- function(data, min_obs = 1) {
  if (nrow(data) < min_obs) {
    beta <- as.numeric(NA)
  } else {
    fit <- lm(excess_returns ~ mkt_excess + smb+hml+ market_excess_returns, data = data)
    beta <- as.numeric(fit$coefficients[2])
  }
  return(beta)
}
# rolling capm estimation
roll_capm_estimation <- function(data, months, min_obs) {
  data <- bind_rows(data) |>
    arrange(date)

  betas <- slide_period_vec(
    .x = data,
    .i = data$date,
    .period = "month",
    .f = ~estimate_capm(., min_obs),
    .before = months - 1,
    .complete = FALSE
  )

  tibble(
    month = unique(data$date),
    beta = betas
  )
}
```
## Step 2: Estimation and Visualization
```{r}
beta_port_tbl <- port_risk_market_tbl %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    drop_na() %>%
    select(date, beta)


beta_port_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = beta,
        .title = "Rolling Beta using 5 years data",
        .x_lab = "",
        .y_lab = "Beta"
    )
```

# Stocks Returns and S&P500 and Fama-French Factors
```{r}
returns_market_risk_tbl <- returns %>%
    group_by(symbol) %>%
    left_join(market_returns, by = "date") %>%
    left_join(factors_ff_monthly, by = "date") %>%
    mutate(excess_returns = monthly.returns -rf) %>%
    mutate(market_excess_returns = market_ret -rf) %>%
    drop_na() %>%
    select(symbol, date, mkt_excess, smb, hml, excess_returns, market_excess_returns)

returns_market_risk_tbl
```  
# Beta Estimation & Visualization
```{r}
beta_stocks_tbl <- returns_market_risk_tbl %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    ungroup() %>%
    select(symbol, date, beta) %>%
    drop_na()


beta_stocks_tbl %>%
    plot_time_series(
        .date_var = date,
        .color_var = symbol,
        .value = beta,
        
        .facet_ncol = 2,
        .smooth = FALSE,
        .x_lab = "",
        .y_lab = "Beta",
        .legend_show = FALSE
    )


```
```{r}
sessionInfo()
```












