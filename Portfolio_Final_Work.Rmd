---
title: "Portfolio_of_Portfolios"
author: "Mandar"
date: "2022-08-31"
output: 
    html_document:
      code_folding: hide
      df_print: paged
      highlight: tango
      number_sections: yes
      theme: flatly
      toc: yes
      toc_depth: 2
---

```{r }
knitr::opts_chunk$set(echo = TRUE,fig.align = "center",
                        message = FALSE,
                      warning = FALSE)
options(tinytex.verbose = TRUE)

```
# loading the required libraries


```{r}
library(tidymodels)
library(tidyquant)
library(tidyverse)
library(scales)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(plotly)
library(timetk)
library(modeltime)
library(DataExplorer)
library(correlationfunnel)
```
# Step 1: Sectoral Returns : Based on GCIS definition



```{r}
# Sectors ----

symbols_consd<- c("TGT","NKE","MCD","HD","CCL") %>% sort()
prices_consd <- symbols_consd %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_consd <- prices_consd %>%
    group_by(symbol) %>%
    select(symbol, date, adjusted) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 periodReturn = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Reality Sector ----

symbols_real <- c("WELL","WY","LPX","DRE","PEAK")
prices_real  <- symbols_real %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_real <- prices_real %>%
    group_by(symbol) %>%
    tq_transmute(
        select = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Communications Sector ----

symbols_comm <- c("VZ","T","DIS","CMCSA","USM") 

prices_comm  <- symbols_comm %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_comm <- prices_comm %>%
    group_by(symbol) %>%
    tq_transmute(
        select = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Financials ----
symbols_fin <- c("JPM","USB","BAC","WFC","C") %>% sort()

prices_fin  <- symbols_fin %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_fin <- prices_fin %>%
    group_by(symbol) %>%
    tq_transmute(
        select = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Health Care Sector ----
symbols_heal <- c("JNJ","PFE","CVS","UNH","AMGN") %>% sort()

prices_heal <- symbols_heal %>% tq_get(get = "stock.prices",from = "1990-01-01")

returns_heal <-prices_heal %>%
    group_by(symbol) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Industrials ----
symbols_ind <- c("GE","HON","BA","CAT","CMI") %>% sort()

prices_ind <- symbols_ind %>% 
    tq_get(
        get = "stock.prices", from ="1990-01-01"
    )
returns_ind <- prices_ind %>%
    group_by(symbol) %>%
    tq_transmute(
        select = adjusted,
        mutate_fun = periodReturn,
        period    = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Materials ----

symbols_mat <- c("NEM","CLF","AA","RPM","DD") %>% sort()

prices_mat <- symbols_mat %>%
    tq_get(get = "stock.prices",from = "1990-01-01")

returns_mat <- prices_mat %>%
    group_by(symbol) %>%
    tq_transmute(
        select     = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    ungroup()

# Utilities ----

symbols_util <- c("DUK","UGI","D","AEP","NEE") %>% sort() 

prices_utils <-  symbols_util %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_utils <-  prices_utils %>%
    group_by(symbol) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Energy Sector ----

symbols_ener <- c("XOM","CVX","OXY","COP","SLB") %>% sort()

prices_ener  <-  symbols_ener %>%
    tq_get(get = "stock.prices",from = "1990-01-01")

returns_ener <- prices_ener %>%
    group_by(symbol) %>%
    tq_transmute( select = adjusted,
                  mutate_fun = periodReturn,
                  period     = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Consumer Discretionary Sector ----

symbols_consd<- c("TGT","NKE","MCD","HD","CCL") %>% sort()
prices_consd <- symbols_consd %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
returns_consd <- prices_consd %>%
    group_by(symbol) %>%
    select(symbol, date, adjusted) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 periodReturn = "monthly") %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))


# Consumer Staples -----
symbols_conss <- c("PG","KO","COST","WMT","KR") %>% sort()

prices_conss <-  symbols_conss%>%
    tq_get(get = "stock.prices", from = "1990-01-01")

returns_conss <-  prices_conss %>%
    group_by(symbol)%>%
    select(symbol, date, adjusted) %>%
    tq_transmute(select     = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

# Technology Sector ----

symbols_tech <- c("AAPL","MSFT","IBM","ORCL","ADBE") %>% sort()
prices_tech  <-  symbols_tech %>%
    tq_get(get = "stock.prices",from = "1990-01-01")

returns_tech <- prices_tech %>%
    group_by(symbol) %>%
    select(date,symbol,adjusted) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = T))

```
# Step 2 : Individual Sector Portfolios ----

```{r}
# Weights allocation based on equal weights scheme
w <- rep(1/5, 5)
```

```{r}
# Real Estate ----
port_real_tbl <- returns_real %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="Real-Estate", .before = 1)

# Communications ----
port_comm_tbl <- returns_comm %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
     ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="Communications", .before = 1)

# Financials ----
port_fin_tbl <- returns_fin %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="Financials", .before = 1)

# Health Care ----
port_heal_tbl <- returns_heal %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="HealthCare", .before = 1)

# Industrials
port_ind_tbl <- returns_ind %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="Industrials", .before = 1)

#  Materials ----
port_mat_tbl <- returns_mat %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col = symbol,
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
    ) %>%
    add_column(symbol="Materials", .before = 1)

# Utilities ----
port_util_tbl <- returns_utils %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col  = symbol, 
        returns_col = monthly.returns,
        weights     =   w,
        rebalance_on = "years"
    ) %>%
    add_column(symbol = "Utilities", .before = 1)
# Energy ----
port_ener_tbl <- returns_ener %>%
    group_by(symbol) %>%
    tq_portfolio(assets_col  = symbol,
                 returns_col = monthly.returns,
                 weights     = w,
                 rebalance_on = "years") %>%
    add_column(symbol = "Energy", .before = 1)
# Consumer Discretionary ----
port_consd_tbl <- returns_consd %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col  = symbol, 
        returns_col = monthly.returns,
        weights   = w ,
        rebalance_on = "years"
         ) %>%
    add_column(symbol = "Consu-Discretion", .before = 1)

# Consumer Staples ----
port_conss_tbl <- returns_conss %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col  = symbol,
        returns_col = monthly.returns,
        weights     = w,
        rebalance_on = "years"
    ) %>%
    add_column(symbol = "Consu-Staples", .before = 1)

# Technology Sector ----
port_tech_tbl <- returns_tech %>% 
    group_by(symbol) %>%
    tq_portfolio(
        assets_col = symbol,
        returns_col = monthly.returns,
        weights = w,
        rebalance_on = "years"
        # change of name to monthly returns
         )  %>%
    # To add the symbol = "Portfolio as otherwise we end with date and returns only
    add_column(symbol = "Tech", .before = 1) 

```
# Step 3 : Portfolio of Portfolios ----
## Step 3.1 - Combining all the portfolio returns
```{r}
ret_tbl <- rbind(
  port_comm_tbl,port_tech_tbl ,port_conss_tbl,port_consd_tbl,port_ener_tbl,
  port_fin_tbl, port_heal_tbl,port_ind_tbl, port_mat_tbl, port_real_tbl,
  port_util_tbl
) %>%
  arrange(symbol)

table(ret_tbl$symbol)

```
## Step 3.2 Creating Portfolio 

```{r}
symbols <- c("Communications","Consu-Discretion","Consu-Staples","Energy",
             "Financials","HealthCare","Industrials","Materials","Real-Estate",
             "Tech","Utilites")

n <- length(symbols)
# Weights

weights <- rep(1/n, n)
portfolio_tbl <- ret_tbl %>%
  group_by(symbol) %>%
  tq_portfolio(
    assets_col   = symbol, 
    returns_col  = portfolio.returns,
    weights      = weights,
    rebalance_on = "years"
  ) %>%
  add_column(symbol = "Portfolio", .before = 1)

portfolio_tbl
```
# Step 4 : Portfolio Returns Visualization

```{r}
portfolio_tbl %>%
    ggplot(aes(date, portfolio.returns)) +
    geom_line() + geom_smooth(method = "loess") +
    scale_y_continuous(labels = scales::percent) +
    theme_tq()  + 
    labs(
        title = "Portfolio Returns ",
        subtitle = "Periods of high volatility 1998, 2008, 2020",
        x = "",
        y = "Returns"
    )
```
# Interactive Visualiaztion with timetk

```{r}
portfolio_tbl %>%
  plot_time_series(
    .date_var = date,
    .value    = portfolio.returns,
    .title = "Portfolio Returns",
    .y_lab = "Returns"
  )

```
# Step 5: Risk Factors , Market Index ----
## Step 5.1:Fama-French Factors ----
```{r}
library(frenchdata)
factors_ff_monthly_raw <- download_french_data("Fama/French 3 Factors")
factors_ff_monthly <- factors_ff_monthly_raw$subsets$data[[1]] |>
    transmute(
        date = floor_date(ymd(str_c(date,"01")),"month"),
        rf = as.numeric(RF) / 100,
        mkt_excess = as.numeric(`Mkt-RF`) / 100,
        smb = as.numeric(SMB) / 100,
        hml = as.numeric(HML) / 100
    ) %>%
    # filter the dates 
    filter(date >= "1990-01-01")

factors_ff_monthly 
```
## Step 5.2: S&P 500 ----
```{r}
market_index <- tq_get("^GSPC",get = "stock.prices",from = "1990-01-01")

market_returns <- market_index %>%
    select(symbol, date, adjusted) %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
                 col_rename = "market_ret"
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) 

```
## Step5.3: Portfolio, Fama-French and S&P500 ----
```{r}
port_risk_market_tbl <- portfolio_tbl %>%
    left_join(factors_ff_monthly, by = "date") %>%
    left_join(market_returns, by = "date") %>%
    mutate(
        excess_returns = portfolio.returns - rf
    ) %>%
    mutate(market_excess_returns = market_ret - rf) %>%
    ungroup() %>%
     drop_na() %>%
    select(symbol, date, excess_returns, market_excess_returns, mkt_excess, smb, hml)

port_risk_market_tbl


```
# Step 6: Beta Estimation ----
## Step 6.1 : CAPM function ----
```{r}
library(slider)
# estimate capm
estimate_capm <- function(data, min_obs = 1) {
    if (nrow(data) < min_obs) {
        beta <- as.numeric(NA)
    } else {
        fit <- lm(excess_returns ~ mkt_excess + smb+hml+ market_excess_returns, data = data)
        beta <- as.numeric(fit$coefficients[2])
    }
    return(beta)
}

## rolling capm estimation 
roll_capm_estimation <- function(data, months, min_obs) {
    data <- bind_rows(data) |>
        arrange(date)
    
    betas <- slide_period_vec(
        .x = data,
        .i = data$date,
        .period = "month",
        .f = ~estimate_capm(., min_obs),
        .before = months - 1,
        .complete = FALSE
    )
    
    tibble(
        month = unique(data$date),
        beta = betas
    )
}

```

## Step 6.2 : Estimation ----

```{r}
beta_port_tbl <- port_risk_market_tbl %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    drop_na() %>%
    select(symbol, date, beta)

```
### Step 6.3 : Visualization ----
```{r}
beta_port_tbl  %>%
  ggplot(aes(date, beta)) +
  geom_line(alpha = 0.9, color = "red") +
  scale_y_continuous() +
  theme_tq() + scale_color_tq() +
  labs(
    title = "Rolling Beta Estimation",
    subtitle = "Using 5 Years of Data",
    x = "",
    y = "Beta"
  )
```
#### Visualization using timetk
```{r}
beta_port_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = beta,
        .smooth = FALSE,
        .title = "Rolling Beta Estimation",
        .x_lab = "",
        .y_lab = "Beta"
    )
```
## Step 7 : Beta Comparisons for All Portfolios
### Step 7.1 Combining all the portfolios
```{r}
port_combined_tbl <- portfolio_tbl %>%
rbind(port_comm_tbl,
      port_consd_tbl,
      port_conss_tbl,
      port_ener_tbl,
      port_fin_tbl,
      port_heal_tbl,
      port_ind_tbl,
      port_mat_tbl,
      port_real_tbl,
      port_tech_tbl,
      port_util_tbl)

port_combined_tbl 

```
### Step 7.2 : Visualization of Portfolio Returns (timetk)
```{r}
port_combined_tbl %>%
  group_by(symbol) %>%
  plot_time_series(
    .date_var = date,
    .value = portfolio.returns,
    .color_var = symbol,
    .smooth = FALSE,
    .facet_scales = "free_y",
    .facet_ncol = 3,
    .legend_show = FALSE
    
  )
```
```{r}
port_combined_tbl %>%
  group_by(symbol) %>%
  ggplot(aes(date, portfolio.returns, color = symbol)) +
  geom_line() + facet_wrap(~symbol) +
  scale_y_continuous(labels = scales::percent) +
  theme_tq() + scale_color_tq(theme = "light") +
  labs(
    title = "Portfolio-Returns",
    subtitle = "Portfolio vs Sectoral-Portfolios ",
    x = "",
    y = "Returns"
  ) + theme(legend.position = "none")
```
### Step 7.3 : Sharpe Ratio Comparison
```{r}
port_combined_tbl %>%
  group_by(symbol) %>%
  tq_performance(
    Ra = portfolio.returns,
    performance_fun = SharpeRatio.annualized,
    Rf = 0.03 /12,
    scale = 12
  ) %>%
  ungroup() %>%
  mutate(symbol = as.factor(symbol)) %>%
  mutate(`AnnualizedSharpeRatio(Rf=3%)`= round(`AnnualizedSharpeRatio(Rf=3%)`, 2) ) %>%
  ggplot(aes(symbol, `AnnualizedSharpeRatio(Rf=3%)`, label = `AnnualizedSharpeRatio(Rf=3%)` ) ) +
  geom_col(fill = "#2c3e50") + scale_y_continuous() +
    theme_tq() + scale_color_tq(theme = "light") +
    geom_label(nudge_y = -0.01) +
    labs(
        title = "Annualized Sharpe Ratio",
        subtitle = "Health-Care  has the highest Sharpe Raito ",
        caption = "Portfolio vs Sectoral Portfolios ",
        x ="", y = "Sharpe Ratio"
    )
  
```

### Step 7.4 : Comparison of Beta for  Portfolo vs Portfolios
#### Step 7.4.1 Combining portfolios and Fama-French and S&P500
```{r}
# 
port_combined_risk_market_tbl <- port_combined_tbl %>% 
  left_join(factors_ff_monthly, by = "date") %>%
  left_join(market_returns , by = "date") %>%
  mutate(excess_returns = portfolio.returns - rf) %>%
  mutate(market_excess_returns = market_ret - rf) %>%
  ungroup() %>%
  drop_na() %>%
  select(symbol, date, excess_returns, market_excess_returns, mkt_excess, smb, hml)

```
#### Step 7.4.2 Beta Estimation
```{r}
beta_tbl <- port_combined_risk_market_tbl  %>%
  group_by(symbol) %>%
  mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
  ungroup() %>%
  drop_na() %>%
  select(symbol, date, beta)
beta_tbl
``` 
#### Step 7.4.3 Visualization 
```{r}
beta_tbl %>%
  plot_time_series(
    .date_var     = date,
    .value        = beta,
    .color_var    = symbol,
    .facet_scales = "free_y",
    .smooth       = FALSE,
    .title        = "Rolling Beta using 5 Years of Data" ,
    .x_lab        = "",
    .y_lab        = "Beta",
    .legend_show  = FALSE
  )
```













