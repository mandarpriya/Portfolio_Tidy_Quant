---
title: "Materials_Sector"
author: "Mandar"
date: "2022-08-25"
output: 
     html_document :
      code_folding: hide
      df_print: paged
      highlight: tango
      number_sections: yes
      theme: flatly
      toc: yes
      toc_depth: 2
---

```{r }
knitr::opts_chunk$set(echo = TRUE,fig.align = "center",
                        message = FALSE,
                      warning = FALSE)
options(tinytex.verbose = TRUE)
```

The basic materials sector is an industry category made up of businesses engaged in the discovery, development, and processing of raw materials. The sector includes companies engaged in mining and metal refining, chemical products, and forestry products.Not all businesses that work with basic materials are included in the sector. For example, while a metal mining company is considered a basic materials processor, a jewelry company, even one which works only with mined metal, is not. It is deemed a retailer or a wholesaler who is a buyer of the basic material.

# Loading the libraries:-
```{r}
library(tidymodels)
library(tidyquant)
library(tidyverse)
library(scales)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(plotly)
library(timetk)
library(modeltime)
library(DataExplorer)
library(correlationfunnel)

```

#  Data for Materials Sector

```{r }
symbols <- c("NEM","CLF","AA","RPM","DD") %>% sort()

prices <- symbols %>%
    tq_get(get = "stock.prices",from = "1990-01-01")

returns <- prices %>%
    group_by(symbol) %>%
    tq_transmute(
        select     = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    ungroup()



```
# Returns Visualization
```{r}
returns %>%
    plot_time_series(
        .date_var = date,
        .value    = monthly.returns,
        .color_var = symbol,
        .facet_ncol = 2,
        .facet_vars = symbol,
        .facet_scales = "free_y",
        .smooth = FALSE,
        .title = "Monthly Returns for Materials Sector",
        .x_lab = "",
        .y_lab = "Monthly Returns"
    )
```
# ggplot for visual

```{r}
returns %>%
    group_by(symbol) %>%
    ggplot(aes(date, monthly.returns, color = symbol)) +
    geom_line() + scale_y_continuous(labels = scales::percent) +
    theme_tq() +
    scale_color_tq(theme = "dark") + facet_wrap(~symbol) +
    labs(
        title = "Monthly Returns",
        subtitle = "Materials Sector",
        caption = "Stocks(NEM,CLF,AA,NUE,DD)",
        x ="",
        y="Monthly Returns"
    ) + theme(legend.position = "none")


```
# Stock Prices Visualization
```{r}
prices %>%
    plot_time_series(
        .date_var = date,
        .value    = adjusted,
        .color_var = symbol,
        .smooth = FALSE,
        .title = "Stock Prices Materials Sector",
        .x_lab = "",
        .y_lab = "Adjusted Prices($)"
        
    )
```
# ggplot
```{r}
prices %>%
    group_by(symbol) %>%
    ggplot(aes(date, adjusted, color = symbol)) + 
    geom_line() + scale_y_continuous(labels = scales::dollar) +
    theme_tq()   +
    labs(
        title = "Stock Prices Materials Sector",
        subtitle = "Upward Trend observed",
        caption = "Stocks(NEM,CLF,AA,PPG,DD)",
        x ="",
        y = "Adjusted Prices"
    )
```
# S&P 500 Data
```{r}
market_prices <- tq_get("^GSPC",get = "stock.prices", from = "1990-01-01")

market_returns <- prices %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period     = "monthly",
                 col_rename = "market_ret"
                 ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE))
market_returns

```
# Fama-French factors
```{r}
library(frenchdata)
factors_ff_monthly_raw <- download_french_data("Fama/French 3 Factors")
factors_ff_monthly <- factors_ff_monthly_raw$subsets$data[[1]] |>
  transmute(
    date = floor_date(ymd(str_c(date,"01")),"month"),
    rf = as.numeric(RF) / 100,
    mkt_excess = as.numeric(`Mkt-RF`) / 100,
    smb = as.numeric(SMB) / 100,
    hml = as.numeric(HML) / 100
  ) %>%
  # filter the dates 
  filter(date >= "1990-01-01")

factors_ff_monthly 
```
# Portfolio Creation
```{r}
w <- rep(1/5,5)
port_ret_tbl <- returns %>%
    group_by(symbol) %>%
    tq_portfolio(
        assets_col = symbol,
        returns_col = monthly.returns,
        weights = w
    ) %>%
    add_column(symbol="Portfolio", .before = 1)

# Visualization
port_ret_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = portfolio.returns,
        .title = "Portfolio Returns Materials Sector",
        .x_lab = "",
        .y_lab = "Monthly Returns"
      )
```
# Combining all the data
```{r}
port_market_risk_tbl <- port_ret_tbl %>%
    left_join(market_returns, by = "date") %>%
    left_join(factors_ff_monthly, by = "date") %>%
    mutate(excess_returns = portfolio.returns -rf) %>%
    mutate(market_excess_returns = market_ret - rf) %>%
    select(symbol, date, excess_returns, market_excess_returns, mkt_excess, smb, hml)
```
# Beta Estimation

##Step 1 : CAPM function

```{r}
library(slider)
# estimate capm
estimate_capm <- function(data, min_obs = 1) {
  if (nrow(data) < min_obs) {
    beta <- as.numeric(NA)
  } else {
    fit <- lm(excess_returns ~ mkt_excess + smb+hml+ market_excess_returns, data = data)
    beta <- as.numeric(fit$coefficients[2])
  }
  return(beta)
}
# rolling capm estimation
roll_capm_estimation <- function(data, months, min_obs) {
  data <- bind_rows(data) |>
    arrange(date)

  betas <- slide_period_vec(
    .x = data,
    .i = data$date,
    .period = "month",
    .f = ~estimate_capm(., min_obs),
    .before = months - 1,
    .complete = FALSE
  )

  tibble(
    month = unique(data$date),
    beta = betas
  )
}
```
##Step2 : Estimation
```{r}
beta_port_tbl <- port_market_risk_tbl %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    drop_na() %>%
    select(symbol, date, beta)
```
##Step3 : Visualization of Beta
```{r}
beta_port_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = beta,
        .title = "Rolling Beta with 5 years of Data",
        .x_lab = "",
        .y_lab = "Beta"
    )
```
##Step4: ggplot
```{r}
beta_port_tbl %>%
    ggplot(aes(date, beta)) +
    geom_line() + geom_smooth(method = "loess") +
    scale_y_continuous() + theme_tq() + scale_color_tq(theme = "light") +
    labs(
        title = "Rolling Beta using 5 years Data",
        subtitle = "Materials Sector",
        caption = "Stocks(NEM,CLF,AA,PPG,DD)",
        x = "",
        y = "Beta"
    )
```
# Stocks Returns, S&P500, Fama-French Factors

```{r}

returns_market_risk_tbl <- returns %>%
    group_by(symbol) %>%
    left_join(factors_ff_monthly, by = "date") %>%
    left_join(market_returns, by = "date") %>%
    mutate(excess_returns = monthly.returns -rf)  %>%
    mutate(market_excess_returns = market_ret - rf) %>%
    drop_na() %>%
    ungroup() %>%
    select(symbol, date, excess_returns, market_excess_returns, mkt_excess, smb, hml)



```
# Beta Estimation
```{r}
beta_stocks_tbl <- returns_market_risk_tbl %>%
    group_by(symbol) %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    drop_na() %>%
    ungroup() %>%
    select(symbol, date, beta)

beta_stocks_tbl 
```
# Beta Visualization
```{r}
beta_stocks_tbl  %>%
    plot_time_series(
        .date_var = date,
        .value = beta,
        .color_var = symbol,
        .facet_ncol = 2,
        .smooth = FALSE,
        .title = "Rolling Beta for Material Stocks",
        .x_lab = "",
        .y_lab = "Beta"
        
    )
```
# ggplot
```{r}
beta_stocks_tbl  %>%
    group_by(symbol) %>%
    ggplot(aes(date, beta, color = symbol)) +
    geom_line() +
    scale_y_continuous( ) + theme_tq() +
    labs(
        title = "Rolling Beta Estimates 5 Years Data ",
        subtitle = "Materials Stocks",
        caption = "Stocks(AA,DD,NEM,CLF,RPM)",
        x ="",
        y="Beta"
    )
    
    
```













