---
title: "Financial_Sector"
author: "Mandar"
date: "2022-08-26"
output: 
    html_document :
      code_folding: hide
      df_print: paged
      highlight: tango
      number_sections: yes
      theme: flatly
      toc: yes
      toc_depth: 2
---

```{r }
knitr::opts_chunk$set(echo = TRUE,fig.align = "center",
                        message = FALSE,
                      warning = FALSE)
options(tinytex.verbose = TRUE)
```
# loading the libraries

```{r}
library(tidymodels)
library(tidyquant)
library(tidyverse)
library(scales)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(plotly)
library(timetk)
library(modeltime)
library(DataExplorer)
library(correlationfunnel)
```

# The financial sector is a section of the economy made up of firms and institutions that provide financial services to commercial and retail customers. This sector comprises a broad range of industries including banks, investment companies, insurance companies, and real estate firms.

# Data for Financial Sector
```{r }
# tickers
symbols <- c("JPM","USB","BAC","WFC","C") %>% sort()
# stock prices
prices  <- symbols %>%
    tq_get(get = "stock.prices", from = "1990-01-01")
# returns
returns <- prices %>%
    group_by(symbol) %>%
    tq_transmute(
        select = adjusted,
        mutate_fun = periodReturn,
        period     = "monthly",
    ) %>%
    ungroup() %>%
    mutate(date = rollback(date, roll_to_first = TRUE))

```
# Visualization of returns
```{r}
returns %>%
    group_by(symbol) %>%
    ggplot(aes(date, monthly.returns, color = symbol)) +
    geom_line() + scale_y_continuous(labels = scales::percent) +
    theme_tq() + facet_wrap(~symbol) + 
    labs(
        title = "Monthly returns",
        subtitle = "Financial Sector",
        caption = "Stocks(JPM,USB,WFC,C,BAC)",
        x = "",
        y = "Monthly Returns"
    ) + theme(legend.position = "none")
```
# Stock Prices Visualization
```{r}
prices %>%
    group_by(symbol) %>%
    plot_time_series(
        .date_var = date,
        .value = adjusted,
        .color_var = symbol,
        .facet_ncol = 2,
        .facet_scales = "free_y",
        .smooth = FALSE,
        .title = "Stock Prices Financial Sector",
        .x_lab = "",
        .y_lab = "Adjusted Prices"
    )
```

# Portfolio construction

```{r }
# Weights Allocation
w <- rep(1/5, 5)
# Portfolio creation
port_ret_tbl <- returns %>%
    tq_portfolio(
        assets_col = symbol, 
        returns_col = monthly.returns,
        weights = w
    ) %>%
    mutate(date = rollback(date, roll_to_first = TRUE)) %>%
    add_column(symbol ="Portfolio", .before = 1)

# Visualization
port_ret_tbl  %>%
    ggplot(aes(date, portfolio.returns)) +
    geom_line() + geom_smooth(method = "loess") +
    scale_y_continuous(labels = scales::percent) + theme_tq() + scale_color_tq() +
    labs(
        title = "Portfolio Returns",
        subtitle = "Communications Sector",
        caption = "Stocks(CMCS",
        y = "Returns",
        x = ""
    )
```
# timetk
```{r}
port_ret_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = portfolio.returns,
        .title = "Portfolio Returns Financial Sector",
        .x_lab = "",
        .y_lab = "Returns"
    )
```
# S&P 500
```{r}
market_prices <- tq_get("^GSPC", get = "stock.prices",from = "1990-01-01")
market_returns <-  market_prices %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period = "monthly",
                 col_rename = "market_ret") %>%
    mutate(date = rollback(date, roll_to_first = TRUE))
market_returns

```
# FAMA-FRENCH DATA
```{r}
library(frenchdata)
factors_ff_monthly_raw <- download_french_data("Fama/French 3 Factors")
factors_ff_monthly <- factors_ff_monthly_raw$subsets$data[[1]] |>
  transmute(
    date = floor_date(ymd(str_c(date,"01")),"month"),
    rf = as.numeric(RF) / 100,
    mkt_excess = as.numeric(`Mkt-RF`) / 100,
    smb = as.numeric(SMB) / 100,
    hml = as.numeric(HML) / 100
  ) %>%
  # filter the dates 
  filter(date >= "1990-01-01")

factors_ff_monthly 
```
# Combining all the data
```{r}
port_risk_market_tbl <- port_ret_tbl %>%
    left_join(factors_ff_monthly, by = "date") %>%
    left_join(market_returns, by = "date") %>%
    mutate(excess_returns = portfolio.returns - rf) %>%
    mutate(market_excess_returns = market_ret - rf) %>%
    select(symbol, date, mkt_excess, smb, hml, excess_returns, market_excess_returns)
```
# Beta Estimation 
## step1:CAPM function
```{r}
library(slider)
# estimate capm
estimate_capm <- function(data, min_obs = 1) {
  if (nrow(data) < min_obs) {
    beta <- as.numeric(NA)
  } else {
    fit <- lm(excess_returns ~ mkt_excess + smb+hml+ market_excess_returns, data = data)
    beta <- as.numeric(fit$coefficients[2])
  }
  return(beta)
}
# rolling capm estimation
roll_capm_estimation <- function(data, months, min_obs) {
  data <- bind_rows(data) |>
    arrange(date)

  betas <- slide_period_vec(
    .x = data,
    .i = data$date,
    .period = "month",
    .f = ~estimate_capm(., min_obs),
    .before = months - 1,
    .complete = FALSE
  )

  tibble(
    month = unique(data$date),
    beta = betas
  )
}
```
## step2: Beta estimation
```{r}
beta_port_tbl <- port_risk_market_tbl %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    drop_na() %>%
    select(symbol, date, beta)
```
## step3: Beta Visualization 
```{r}
beta_port_tbl %>%
    ggplot(aes(date, beta)) +
    geom_line() + geom_smooth(method = "loess") +
    scale_y_continuous() + theme_tq() + scale_color_tq() +
    labs(
        title = "Rolling Beta using 5 years data",
        subtitle = "Financial Sector",
        caption = "Stocks(C, JPM, BAC, WFC, USB)",
        x ="",
        y="Beta"
    )
```
# Stock Returns , Fama-French and S&P 500
```{r}
returns_risk_market_tbl <- returns %>%
    group_by(symbol) %>%
    left_join(factors_ff_monthly, by = "date") %>%
    left_join(market_returns, by = "date") %>%
    mutate(excess_returns = monthly.returns -rf) %>%
    mutate(market_excess_returns = market_ret - rf) %>%
    ungroup() %>%
    drop_na() %>%
    select(symbol, date, excess_returns, market_excess_returns, mkt_excess, smb, hml)

```
## Beta Estimation for Stocks
```{r}
beta_stocks_tbl <- returns_risk_market_tbl %>%
    group_by(symbol) %>%
    mutate(roll_capm_estimation(cur_data(), months = 60, min_obs = 48)) %>%
    ungroup() %>%
    drop_na() %>%
    select(symbol, date, beta)
beta_stocks_tbl
```
# Beta Visualization
```{r}
beta_stocks_tbl %>%
    ggplot(aes(date, beta, color = symbol)) +
    geom_line() + scale_y_continuous() +
    theme_tq() +
    labs(
        title = "Rolling beta with 5 years of data",
        subtitle = "Financial Sector",
        capition = "stocks(C, USB,BAC, WFC, JPM)",
        y ="Beta",
        x =""
    ) 
```

# timetk
```{r}
beta_stocks_tbl %>%
    plot_time_series(
        .date_var = date,
        .value = beta,
        .color_var = symbol,
        .smooth = FALSE,
        .title = "Rolling Beta With 5 years of Data",
        .x_lab = "",
        .y_lab = "Beta"
    )
```










